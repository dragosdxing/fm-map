<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FM Map Romania</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;}
#map{height:100vh;width:100vw;}

#radioPanel{
    position:absolute;
    top:10px;
    left:60px;
    background:white;
    padding:8px 12px;
    border-radius:10px;
    box-shadow:0 2px 10px rgba(0,0,0,0.35);
    z-index:1000;
    font-family:Arial;
    font-size:14px;
}

#radioPanel button{
    font-size:16px;
    padding:3px 8px;
    margin:2px;
}

#freqInput{
    width:60px;
    text-align:center;
    font-weight:bold;
    border:1px solid #aaa;
    border-radius:6px;
}
</style>
</head>

<body>

<div id="map"></div>

<div id="radioPanel">
    <b>FM Tuner</b><br>
    <button onclick="stepDown()">−</button>
    <input id="freqInput" type="text" value="97.9" readonly>
    <button onclick="stepUp()">+</button>
    <button onclick="tune()">Tune</button>
</div>

<script>

// creează harta
var map = L.map('map').setView([45.8, 26.5], 7);

// OpenStreetMap
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:19,
    attribution:'© OpenStreetMap'
}).addTo(map);

let allStations = [];
let geoLayer;

// -------------------
// ÎNCĂRCARE BAZĂ DATE
// -------------------
fetch('fm.json')
.then(response => response.json())
.then(data => {

    allStations = data.features;

    // inițial arată toate stațiile
    geoLayer = L.geoJSON(data,{
        onEachFeature: function(feature, layer){

            if(feature.properties){
                let desc = formatDescription(feature.properties.description || "");

                layer.bindPopup(
                    "<b>" + (feature.properties.name || "") + "</b><br>" + desc
                );
            }
        }
    }).addTo(map);
});


// -------------------
// FORMATARE TEXT POPUP
// -------------------
function formatDescription(desc){

    // separă fiecare stație pe linie nouă
    desc = desc.replace(/(\d{2,3}\.\d\s*[hv])/gi, "<br>$1");

    // scoate <br> de la început
    if(desc.startsWith("<br>"))
        desc = desc.substring(4);

    return desc;
}


// -------------------
// TUNER
// -------------------
function tune(){

    let freq = parseFloat(document.getElementById("freqInput").value);

    if(geoLayer)
        map.removeLayer(geoLayer);

    let filteredFeatures = [];

    allStations.forEach(f => {

        let desc = f.properties.description || "";

        // separă stațiile individuale
        let stations = desc.split(/(?=\d{2,3}\.\d\s*[hv])/i);

        let matched = stations.filter(s => {

            let m = s.match(/\d{2,3}\.\d/);
            if(!m) return false;

            return Math.abs(parseFloat(m[0]) - freq) < 0.05;
        });

        if(matched.length > 0){

            let newFeature = JSON.parse(JSON.stringify(f));
            newFeature.properties.description = formatDescription(matched.join("<br>"));

            filteredFeatures.push(newFeature);
        }
    });

    geoLayer = L.geoJSON({
        type:"FeatureCollection",
        features: filteredFeatures
    },{
        onEachFeature: function(feature, layer){

            layer.bindPopup(
                "<b>" + (feature.properties.name || "") + "</b><br>" +
                feature.properties.description
            );
        }
    }).addTo(map);
}


// -------------------
// ACORD +/- 0.1 MHz
// -------------------
function stepUp(){
    let f = parseFloat(freqInput.value);
    f = Math.min(108, f + 0.1);
    freqInput.value = f.toFixed(1);
    tune();
}

function stepDown(){
    let f = parseFloat(freqInput.value);
    f = Math.max(87.5, f - 0.1);
    freqInput.value = f.toFixed(1);
    tune();
}

</script>

</body>
</html>
