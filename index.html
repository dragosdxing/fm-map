<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; }
#map { height:100vh; width:100vw; }

#radioPanel {
    position: absolute;
    top: 10px;
    left: 60px;
    background: white;
    padding: 10px 14px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

#radioPanel input { 
    width: 60px; 
    text-align: center;
    font-weight: bold;
}

.tune-btn {
    width: 26px;
    height: 26px;
    font-weight: bold;
    cursor: pointer;
    background: #eee;
    border: 1px solid #ccc;
    border-radius: 4px;
}
.tune-btn:hover { background: #ddd; }

.countryBtn { 
    margin-top: 6px; 
    cursor: pointer;
    padding: 4px 8px;
    border: 1px solid #aaa;
    background: #f8f8f8;
    border-radius: 4px;
}
.countryBtn.active {
    background: #007bff;
    color: white;
    border-color: #0056b3;
}

/* ================= STILIZARE RDS TIP RADIO ================= */
.rds-box {
    display: inline-block;
    background: #111;
    color: #ff9900;
    font-family: 'Courier New', Courier, monospace;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    letter-spacing: 2px;
    min-width: 85px;
    text-align: center;
    box-shadow: inset 0 0 5px rgba(255,153,0,0.4);
    text-transform: uppercase;
}
</style>
</head>

<body>

<div id="radioPanel">
    <b>FM Tuner</b><br><br>
    
    <button class="tune-btn" onclick="stepFreq(-0.1)">-</button>
    <input id="freqInput" type="number" step="0.1" min="87.5" max="108" value="97.9">
    <button class="tune-btn" onclick="stepFreq(0.1)">+</button>
    
    <br><br>
    Country:<br>
    <button id="btn-ro" class="countryBtn active" onclick="setCountry('ro')">Romania</button>
    <button id="btn-md" class="countryBtn" onclick="setCountry('md')">Moldova</button>
</div>

<div id="map"></div>

<script>
/* ================= MAP ================= */
var map = L.map('map').setView([46.1, 26.5], 7);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19
}).addTo(map);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19
}).addTo(map);

/* ================= ICONS ================= */
var txIcon = L.icon({
    iconUrl:'https://i.ibb.co/Bh7GDMv/antenna.png',
    iconSize:[26,26],
    iconAnchor:[13,26],
    popupAnchor:[0,-26]
});

var receiverIcon = L.icon({
    iconUrl:'https://i.ibb.co/MkmK51LJ/yagi.png',
    iconSize:[34,34],
    iconAnchor:[17,34],
    popupAnchor:[0,-30]
});

/* ================= GLOBALS ================= */
let geoLayer = null;
let allStations = [];
let currentCountry = "ro";
let receiverMarker = null;
let distanceLine = null;

/* ================= DISTANCE FORMAT ================= */
function formatDistance(km){
    if(km < 1) return Math.round(km*1000) + " m";
    return Math.round(km) + " km";
}

/* ================= REVERSE GEOCODING ================= */
async function getLocationName(lat,lon){
    try {
        let url=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1`;
        let r = await fetch(url, { headers: { "Accept":"application/json" } });
        let data = await r.json();
        let a = data.address;
        return (a.city || a.town || a.village || a.municipality || a.county || "Unknown location");
    } catch {
        return "Unknown location";
    }
}

/* ================= LOAD DATA ================= */
function loadStations(country){
    let file = country === "ro" ? "fm.json" : "fm_md.json";

    fetch(file)
    .then(r => r.json())
    .then(data => {
        allStations = data.features;
        tune(); // re-tunează automat la schimbarea țării
    })
    .catch(err => console.error("Eroare la încărcarea fișierului JSON:", err));
}

loadStations("ro"); // Încărcare inițială

/* ================= TUNE & PARSE ================= */
function tune(){
    if(!allStations.length) return;

    let freq = parseFloat(document.getElementById("freqInput").value);
    if(geoLayer) map.removeLayer(geoLayer);

    let filtered = [];
    
    // Expresie regulată strictă pentru banda FM (87.x - 108.x)
    let regexFM = /\b(?:8[7-9]|9[0-9]|10[0-8])[\.,]\d+\b/;

    allStations.forEach(f => {
        let desc = f.properties.description || "";

        // Împărțim textul acolo unde întâlnim o frecvență, păstrând frecvența în string
        let stations = desc.split(/(?=\b(?:8[7-9]|9[0-9]|10[0-8])[\.,]\d+\b)/gi);

        let matched = stations.filter(s => {
            let m = s.match(regexFM);
            if(!m) return false;
            let fVal = parseFloat(m[0].replace(",", "."));
            // Toleranță de ±0.05 MHz
            return Math.abs(fVal - freq) <= 0.05;
        });

        if(matched.length > 0){
            let newF = JSON.parse(JSON.stringify(f));
            
            // Formatăm datele extrase
            let formatted = matched.map(s => {
                // Îngroșăm frecvența
                let s2 = s.replace(regexFM, "<b>$&</b>");
                // Transformăm textul dintre [ ] în display RDS
                s2 = s2.replace(/\[(.*?)\]/g, `<span class="rds-box" data-rds="$1">[$1]</span>`);
                return s2;
            });

            newF.properties.description = formatted.join("<br><hr>");
            filtered.push(newF);
        }
    });

    geoLayer = L.geoJSON({
        type: "FeatureCollection",
        features: filtered
    }, {
        pointToLayer: function(feature, latlng){
            return L.marker(latlng, {icon: txIcon});
        },
        onEachFeature: function(feature, layer){
            // ATENȚIE: Aici era bug-ul în vechiul cod (un .replace() redundant care strica structura). 
            // Acum descrierea vine gata formatată din funcția de mai sus.
            let desc = feature.properties.description || "";
            let name = feature.properties.name || "Emițător necunoscut";

            layer.bindPopup(`<b>${name}</b><br><br>${desc}`);

            layer.on("contextmenu", function(e){
                if(!receiverMarker) return;
                if(distanceLine) map.removeLayer(distanceLine);

                let p1 = receiverMarker.getLatLng();
                let p2 = e.latlng;

                distanceLine = L.polyline([p1, p2], {color: "yellow", weight: 3}).addTo(map);

                let distKm = map.distance(p1, p2) / 1000;
                let dist = formatDistance(distKm);
                let azimuth = bearing(p1, p2);

                layer.bindPopup(
                    `<b>${name}</b><br><br>${desc}` +
                    `<hr><b>Distance:</b> ${dist}<br>` +
                    `<b>Beam:</b> ${azimuth.toFixed(0)}°`
                ).openPopup();
            });
        }
    }).addTo(map);
}

/* ================= RDS ANIMATION SCRIPT ================= */
setInterval(() => {
    document.querySelectorAll('.rds-box').forEach(box => {
        let rdsText = box.getAttribute('data-rds');
        if(rdsText && rdsText.trim().length > 0) {
            // Dacă textul e mai scurt de 8 caractere, îl completăm cu spații pentru realism
            if(rdsText.length < 8) rdsText = rdsText.padEnd(8, " ");
            
            // Efect de scrolling la stânga (mutăm primul caracter la final)
            let nextText = rdsText.substring(1) + rdsText.charAt(0);
            box.setAttribute('data-rds', nextText);
            
            // Afișăm în consolă "fereastra" de 8 caractere tipică ecranelor radio
            box.innerText = `[${nextText.substring(0, 8)}]`; 
        }
    });
}, 400); // Viteza de scroll a RDS-ului (400ms)

/* ================= AUTO TUNE CONTROLS ================= */
function stepFreq(delta) {
    let input = document.getElementById("freqInput");
    let val = parseFloat(input.value) + delta;
    
    // Looping benzii FM
    if(val < 87.5) val = 108.0;
    if(val > 108.0) val = 87.5;
    
    input.value = val.toFixed(1);
    tune();
}

document.getElementById("freqInput").addEventListener("input", tune);
document.getElementById("freqInput").addEventListener("keyup", e => {
    if(e.key === "Enter") tune();
});

/* ================= COUNTRY SWITCH ================= */
function setCountry(c){
    currentCountry = c;
    
    // Update la butoane (design activ/inactiv)
    document.getElementById("btn-ro").classList.toggle("active", c === "ro");
    document.getElementById("btn-md").classList.toggle("active", c === "md");
    
    loadStations(c);
}

/* ================= RECEIVER & BEARING ================= */
map.on("contextmenu", function(e){
    if(e.originalEvent.target.closest(".leaflet-marker-icon")) return;

    if(receiverMarker){ map.removeLayer(receiverMarker); receiverMarker = null; }
    if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }

    receiverMarker = L.marker(e.latlng, {
        icon: receiverIcon,
        draggable: true
    }).addTo(map);

    receiverMarker.bindPopup("<b>Searching location...</b>").openPopup();

    getLocationName(e.latlng.lat, e.latlng.lng).then(name => {
        receiverMarker.setPopupContent(`<b>${name}</b><br>(right click to remove)`);
    });

    receiverMarker.on("drag", () => {
        if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
    });

    receiverMarker.on("dragend", () => {
        let p = receiverMarker.getLatLng();
        receiverMarker.setPopupContent("<b>Searching location...</b>");
        getLocationName(p.lat, p.lng).then(name => {
            receiverMarker.setPopupContent(`<b>${name}</b><br>(right click to remove)`);
        });
    });

    receiverMarker.on("contextmenu", () => {
        map.removeLayer(receiverMarker); receiverMarker = null;
        if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
    });
});

function bearing(a, b){
    let lat1 = a.lat * Math.PI / 180;
    let lat2 = b.lat * Math.PI / 180;
    let dLon = (b.lng - a.lng) * Math.PI / 180;
    let y = Math.sin(dLon) * Math.cos(lat2);
    let x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;
    return (brng + 360) % 360;
}
</script>
</body>
</html>
