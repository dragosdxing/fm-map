<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html, body { margin:0; padding:0; background: #000; }
#map { height:100vh; width:100vw; }

/* ================= DARK MODE PANOU CONTROL ================= */
#radioPanel {
    position: absolute;
    top: 10px;
    left: 60px;
    background: #222;
    color: #eee;
    padding: 14px 18px;
    border-radius: 8px;
    border: 1px solid #444;
    box-shadow: 0 4px 15px rgba(0,0,0,0.8);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
}

#radioPanel input { 
    width: 65px; 
    text-align: center;
    font-weight: bold;
    background: #111;
    color: #00ff00;
    border: 1px solid #555;
    padding: 4px;
    border-radius: 4px;
    font-size: 15px;
}

#radioPanel input::-webkit-outer-spin-button,
#radioPanel input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
#radioPanel input[type=number] { -moz-appearance: textfield; }

.tune-btn {
    width: 30px;
    height: 30px;
    font-weight: bold;
    cursor: pointer;
    background: #333;
    color: #fff;
    border: 1px solid #555;
    border-radius: 4px;
    font-size: 16px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
}
.tune-btn:hover { background: #444; }

.countryBtn { 
    margin-top: 6px; 
    cursor: pointer;
    padding: 6px 12px;
    border: 1px solid #555;
    background: #333;
    color: #ccc;
    border-radius: 4px;
    font-weight: bold;
    transition: all 0.2s;
}
.countryBtn:hover { background: #444; }
.countryBtn.active { background: #00ff00; color: #111; border-color: #00cc00; }

.geo-btn {
    width: 100%;
    margin-top: 10px;
    margin-bottom: 10px;
    padding: 6px;
    cursor: pointer;
    background: #1a4a1a;
    color: #00ff00;
    border: 1px solid #00ff00;
    border-radius: 4px;
    font-weight: bold;
    transition: 0.2s;
}
.geo-btn:hover { background: #00ff00; color: #111; }

/* ================= STILIZARE RDS TIP RADIO ================= */
.rds-box {
    display: inline-block;
    background: #111;
    color: #00ff00;
    font-family: 'Courier New', Courier, monospace;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    letter-spacing: 2px;
    min-width: 95px;
    text-align: center;
    box-shadow: inset 0 0 5px rgba(0,255,0,0.4);
}

/* ================= DARK MODE LEAFLET POPUPS ================= */
.leaflet-popup-content-wrapper {
    background: rgba(25, 25, 25, 0.85); 
    backdrop-filter: blur(4px); 
    -webkit-backdrop-filter: blur(4px);
    color: #eee;
    border: 1px solid #444;
    box-shadow: 0 3px 14px rgba(0,0,0,0.8);
    border-radius: 6px;
}
.leaflet-popup-tip { background: rgba(25, 25, 25, 0.85); border-top: 1px solid #444; border-left: 1px solid #444; }
.leaflet-popup-content { margin: 14px; line-height: 1.5; }
.leaflet-container a.leaflet-popup-close-button { color: #aaa; }
.leaflet-container a.leaflet-popup-close-button:hover { color: #fff; }
hr { border: 0; border-top: 1px solid #555; margin: 10px 0; }
.leaflet-popup-content a { color: #00ff00; }

/* ================= DARK MODE TOOLTIPS (HOVER) ================= */
.leaflet-tooltip {
    background: rgba(25, 25, 25, 0.9);
    color: #eee;
    border: 1px solid #444;
    box-shadow: 0 2px 8px rgba(0,0,0,0.8);
    border-radius: 4px;
    font-size: 13px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    text-align: center;
}
.leaflet-tooltip-top:before { border-top-color: #444; }

/* ================= COVERAGE BUTTON ================= */
.cov-btn {
    background: #333;
    color: #00ff00;
    border: 1px solid #00ff00;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 8px;
    width: 100%;
    transition: 0.2s;
    font-size: 13px;
}
.cov-btn:hover { background: #00ff00; color: #111; }
.cov-btn.active-cov { background: #ff4444; color: #fff; border-color: #ff4444; }
.cov-btn.active-cov:hover { background: #cc0000; }
</style>
</head>

<body>

<div id="radioPanel">
    <div style="margin-bottom: 10px; font-size: 16px;"><b>üìª FM Tuner</b></div>
    
    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
        <button class="tune-btn" onclick="stepFreq(-0.1)">-</button>
        <input id="freqInput" type="number" step="0.1" min="87.5" max="108" value="97.9">
        <button class="tune-btn" onclick="stepFreq(0.1)">+</button>
    </div>
    
    <button id="geoBtn" class="geo-btn" onclick="locateUser()">üìç Geolocation</button>
    
    <div style="font-size: 12px; margin-bottom: 4px; margin-top: 10px; color: #aaa;">Country / Database:</div>
    <button id="btn-ro" class="countryBtn active" onclick="setCountry('ro')">Romania</button>
    <button id="btn-md" class="countryBtn" onclick="setCountry('md')">Moldova</button>
</div>

<div id="map"></div>

<script>
/* ================= MAP ================= */
var map = L.map('map').setView([46.1, 26.5], 7);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);
L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);

/* ================= ICONS ================= */
var txIcon = L.icon({
    iconUrl: 'https://i.ibb.co/Bh7GDMv/antenna.png',
    iconSize: [26, 26], iconAnchor: [13, 26], popupAnchor: [0, -26], tooltipAnchor: [0, -26]
});
var receiverIcon = L.icon({
    iconUrl: 'https://i.ibb.co/MkmK51LJ/yagi.png',
    iconSize: [34, 34], iconAnchor: [17, 34], popupAnchor: [0, -30]
});

/* ================= GLOBALS ================= */
let geoLayer = null;
let allStations = [];
let currentCountry = "ro";
let receiverMarker = null;
let distanceLine = null;
let activeCoverages = {};

function formatDistance(km){
    if(km < 1) return Math.round(km * 1000) + " m";
    return Math.round(km) + " km";
}

async function getLocationName(lat, lon){
    try {
        let url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1`;
        let r = await fetch(url, { headers: { "Accept": "application/json" } });
        let data = await r.json();
        return (data.address.city || data.address.town || data.address.village || data.address.municipality || data.address.county || "Unknown location");
    } catch { return "Unknown location"; }
}

/* ================= LOAD DATA ================= */
function loadStations(country){
    let file = country === "ro" ? "fm.json" : "fm_md.json";
    fetch(file).then(r => r.json()).then(data => {
        allStations = data.features;
        tune();
    }).catch(err => console.error("Eroare la √ÆncƒÉrcarea JSON:", err));
}
loadStations("ro"); 

/* ================= GEOLOCATION ================= */
function locateUser() {
    let btn = document.getElementById("geoBtn");

    if (!navigator.geolocation) {
        alert("Geoloca»õia nu este suportatƒÉ de browser-ul tƒÉu.");
        return;
    }

    btn.innerHTML = "‚è≥ Locating...";

    navigator.geolocation.getCurrentPosition(
        (position) => {
            let lat = position.coords.latitude;
            let lng = position.coords.longitude;
            let latlng = L.latLng(lat, lng);

            // Stergem linia de distanta daca exista
            if (distanceLine) { map.removeLayer(distanceLine); distanceLine = null; }

            // Mutam sau cream receptorul
            if (!receiverMarker) {
                receiverMarker = L.marker(latlng, { icon: receiverIcon, draggable: true }).addTo(map);
            } else {
                receiverMarker.setLatLng(latlng);
            }

            // Centram harta
            map.flyTo(latlng, 12);

            receiverMarker.bindPopup("<b>Searching location...</b>").openPopup();

            getLocationName(lat, lng).then(name => {
                receiverMarker.setPopupContent(`<b>üìç ${name}</b><br>(right click to remove)`);
            });

            btn.innerHTML = "üìç Geolocation";
            
            // Reparam evenimentele de drag pentru marker-ul creat/mutat
            receiverMarker.off("drag");
            receiverMarker.off("dragend");
            receiverMarker.off("contextmenu");
            
            receiverMarker.on("drag", () => { if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; } });
            receiverMarker.on("dragend", () => {
                let p = receiverMarker.getLatLng();
                receiverMarker.setPopupContent("<b>Searching location...</b>");
                getLocationName(p.lat, p.lng).then(name => { receiverMarker.setPopupContent(`<b>${name}</b><br>(right click to remove)`); });
            });
            receiverMarker.on("contextmenu", () => {
                map.removeLayer(receiverMarker); receiverMarker = null;
                if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
            });

        }, 
        (error) => {
            alert("Nu am putut ob»õine loca»õia. AsigurƒÉ-te cƒÉ i-ai dat browser-ului permisiunea de a folosi GPS-ul.");
            btn.innerHTML = "üìç Geolocation";
            console.error(error);
        },
        { enableHighAccuracy: true } // Fortam GPS-ul daca exista pe device
    );
}

/* ================= COVERAGE LOGIC (MATH ONLY) ================= */
window.toggleCoverage = function(lat, lng, powerWatts, btnId) {
    let id = lat + "_" + lng;
    let btn = document.getElementById(btnId);

    // Opreste acoperirea daca e deja pornita
    if (activeCoverages[id]) {
        map.removeLayer(activeCoverages[id]);
        delete activeCoverages[id];
        if(btn) { btn.innerText = "üì∂ Show Coverage"; btn.classList.remove('active-cov'); }
        return;
    }

    // CALCUL MATEMATIC PENTRU TOTI
    let baseRadiusKm = Math.pow(powerWatts, 0.25);
    let rStrong = (baseRadiusKm * 5) * 1000;
    let rWeak = (baseRadiusKm * 9) * 1000;

    // Limita de securitate sa nu acoperim tot globul din greseala
    if (rStrong > 100000) rStrong = 100000; 
    if (rWeak > 180000) rWeak = 180000;

    let covWeak = L.circle([lat, lng], { radius: rWeak, color: 'none', fillColor: '#ffff00', fillOpacity: 0.15 });
    let covStrong = L.circle([lat, lng], { radius: rStrong, color: 'none', fillColor: '#00ff00', fillOpacity: 0.25 });

    let coverageGroup = L.layerGroup([covWeak, covStrong]).addTo(map);
    activeCoverages[id] = coverageGroup;

    if(btn) { btn.innerText = "‚ùå Hide Coverage"; btn.classList.add('active-cov'); }
};

/* ================= TUNE & PARSE ================= */
function tune(){
    if(!allStations.length) return;
    let freq = parseFloat(document.getElementById("freqInput").value);
    
    if(geoLayer) map.removeLayer(geoLayer);
    
    for (let key in activeCoverages) { map.removeLayer(activeCoverages[key]); }
    activeCoverages = {};

    let filtered = [];
    let regexFM = /\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b/;

    allStations.forEach(f => {
        let desc = f.properties.description || "";
        let stations = desc.split(/(?=\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b)/gi);

        let matched = stations.filter(s => {
            let m = s.match(regexFM);
            if(!m) return false;
            let fVal = parseFloat(m[0].replace(",", "."));
            return Math.abs(fVal - freq) <= 0.05;
        });

        if(matched.length > 0){
            let newF = JSON.parse(JSON.stringify(f));
            let formatted = matched.map(s => {
                let s2 = s.replace(regexFM, "<b style='color:#00ff00;'>$&</b>"); 
                s2 = s2.replace(/(W|kW|w|kw)\s*((?:\[[^\]]+\]\s*)+)(\s*\([^)]+\))?$/, function(match, powerStr, rdsBlocks, extraText) {
                    extraText = extraText || "";
                    let frames = rdsBlocks.match(/\[([^\]]+)\]/g).map(frame => frame.slice(1, -1));
                    let safeFrames = encodeURIComponent(JSON.stringify(frames));
                    return powerStr + ` <span class="rds-box" data-frames="${safeFrames}" data-idx="0">[${frames[0]}]</span>` + extraText;
                });
                return s2;
            });
            newF.properties.description = formatted.join("<br><hr>");
            filtered.push(newF);
        }
    });

    geoLayer = L.geoJSON({
        type: "FeatureCollection", features: filtered
    }, {
        pointToLayer: function(feature, latlng){ return L.marker(latlng, {icon: txIcon}); },
        onEachFeature: function(feature, layer){
            let desc = feature.properties.description || "";
            let name = feature.properties.name || "Unknown Transmitter";
            
            let lat = feature.geometry.coordinates[1];
            let lng = feature.geometry.coordinates[0];
            let id = lat + "_" + lng;

            let powerWatts = 100;
            let powerMatch = desc.match(/-\s*([\d\.,]+)\s*(W|kW)/i);
            if (powerMatch) {
                let val = parseFloat(powerMatch[1].replace(",", "."));
                let unit = powerMatch[2].toLowerCase();
                powerWatts = unit === "kw" ? val * 1000 : val;
            }

            let covBtnId = "cov_" + lat.toString().replace(/\./g, "") + "_" + lng.toString().replace(/\./g, "");
            
            let coverageHtml = `<button id="${covBtnId}" class="cov-btn" onclick="toggleCoverage(${lat}, ${lng}, ${powerWatts}, '${covBtnId}')">üì∂ Show Coverage</button>`;

            layer.bindTooltip(`<b style="color:#00ff00;">${name}</b>`, { direction: 'top', offset: [0, -10], opacity: 1 });

            layer.on("mouseover", function(e){
                let tooltipContent = `<b style="color:#00ff00;">${name}</b>`;
                if (receiverMarker) {
                    let distKm = map.distance(receiverMarker.getLatLng(), e.latlng) / 1000;
                    tooltipContent += `<br><span style="font-size:11px; color:#aaa;">Dist: <span style="color:#fff;">${formatDistance(distKm)}</span></span>`;
                }
                layer.setTooltipContent(tooltipContent);
            });

            layer.bindPopup(`<b style="font-size:15px;">${name}</b><br><hr>${desc}<hr>${coverageHtml}`);

            layer.on('popupopen', function() {
                let btn = document.getElementById(covBtnId);
                if (btn) {
                    if (activeCoverages[id]) {
                        btn.innerText = "‚ùå Hide Coverage";
                        btn.classList.add('active-cov');
                    } else {
                        btn.innerText = "üì∂ Show Coverage";
                        btn.classList.remove('active-cov');
                    }
                }
            });

            layer.on("contextmenu", function(e){
                if(!receiverMarker) return;
                if(distanceLine) map.removeLayer(distanceLine);

                let p1 = receiverMarker.getLatLng();
                let p2 = e.latlng;
                distanceLine = L.polyline([p1, p2], {color: "#00ff00", weight: 3, dashArray: "5, 5"}).addTo(map);

                let distKm = map.distance(p1, p2) / 1000;
                let dist = formatDistance(distKm);
                let azimuth = bearing(p1, p2);

                layer.bindPopup(
                    `<b style="font-size:15px;">${name}</b><br><hr>${desc}` +
                    `<hr><div style="color:#aaa;"><b>Distance:</b> <span style="color:#00ff00;">${dist}</span><br>` +
                    `<b>Beam:</b> <span style="color:#00ff00;">${azimuth.toFixed(0)}¬∞</span></div>` +
                    `<hr>${coverageHtml}`,
                    { autoPan: false } 
                ).openPopup();

                map.flyToBounds(distanceLine.getBounds(), { paddingTopLeft: [50, 220], paddingBottomRight: [50, 50], maxZoom: 14 });
            });
        }
    }).addTo(map);
}

/* ================= RDS ANIMATION SCRIPT ================= */
setInterval(() => {
    document.querySelectorAll('.rds-box').forEach(box => {
        let framesAttr = box.getAttribute('data-frames');
        if (framesAttr) {
            let frames = JSON.parse(decodeURIComponent(framesAttr));
            if (frames.length > 1) {
                let idx = parseInt(box.getAttribute('data-idx'));
                idx = (idx + 1) % frames.length; 
                box.setAttribute('data-idx', idx);
                box.innerText = `[${frames[idx]}]`;
            }
        }
    });
}, 2500);

/* ================= AUTO TUNE CONTROLS ================= */
function stepFreq(delta) {
    let input = document.getElementById("freqInput");
    let val = parseFloat(input.value) + delta;
    if(val < 87.5) val = 108.0;
    if(val > 108.0) val = 87.5;
    input.value = val.toFixed(1);
    tune();
}

document.getElementById("freqInput").addEventListener("input", tune);
document.getElementById("freqInput").addEventListener("keyup", e => { if(e.key === "Enter") tune(); });

/* ================= COUNTRY SWITCH ================= */
function setCountry(c){
    currentCountry = c;
    document.getElementById("btn-ro").classList.toggle("active", c === "ro");
    document.getElementById("btn-md").classList.toggle("active", c === "md");
    loadStations(c);
}

/* ================= RECEIVER & BEARING (MANUAL) ================= */
map.on("contextmenu", function(e){
    if(e.originalEvent.target.closest(".leaflet-marker-icon")) return;
    if(receiverMarker){ map.removeLayer(receiverMarker); receiverMarker = null; }
    if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }

    receiverMarker = L.marker(e.latlng, { icon: receiverIcon, draggable: true }).addTo(map);
    receiverMarker.bindPopup("<b>Searching location...</b>").openPopup();

    getLocationName(e.latlng.lat, e.latlng.lng).then(name => { receiverMarker.setPopupContent(`<b>${name}</b><br>(right click to remove)`); });
    
    receiverMarker.on("drag", () => { if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; } });
    receiverMarker.on("dragend", () => {
        let p = receiverMarker.getLatLng();
        receiverMarker.setPopupContent("<b>Searching location...</b>");
        getLocationName(p.lat, p.lng).then(name => { receiverMarker.setPopupContent(`<b>${name}</b><br>(right click to remove)`); });
    });
    receiverMarker.on("contextmenu", () => {
        map.removeLayer(receiverMarker); receiverMarker = null;
        if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
    });
});

function bearing(a, b){
    let lat1 = a.lat * Math.PI / 180; let lat2 = b.lat * Math.PI / 180;
    let dLon = (b.lng - a.lng) * Math.PI / 180;
    let y = Math.sin(dLon) * Math.cos(lat2);
    let x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;
    return (brng + 360) % 360;
}
</script>
</body>
</html>
