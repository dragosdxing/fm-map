<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
@import url('https://fonts.cdnfonts.com/css/ds-digital');

html, body { margin:0; padding:0; background: #000; }
#map { height:100vh; width:100vw; }

/* ================= STILURI ALERTE È˜I ERORI ================= */
.status-error-text {
    color: #ff4444 !important;
    font-weight: bold;
}

/* ================= DARK MODE PANOU CONTROL ================= */
#radioPanel {
    position: absolute;
    top: 10px;
    left: 60px;
    background: #2b2d31; 
    color: #eee;
    padding: 16px 20px;
    border-radius: 8px;
    border: 1px solid #1e1f22;
    box-shadow: 0 4px 15px rgba(0,0,0,0.8);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
    width: 280px;
}

.lcd-screen {
    background: #111;
    border: 1px solid #000;
    border-radius: 4px;
    padding: 4px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 80px;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.9);
}

#freqInput { 
    background: transparent;
    border: none;
    color: #00ff00; 
    font-family: 'DS-Digital', sans-serif;
    font-size: 30px;
    font-weight: normal;
    text-align: center;
    width: 100%;
    outline: none;
    padding: 0;
    margin: 0;
    letter-spacing: 2px;
    text-shadow: 0 0 6px rgba(0,255,0,0.4);
}

.mhz-label {
    color: #00ff00; 
    font-size: 11px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    margin-top: -2px;
    letter-spacing: 1px;
    text-shadow: 0 0 3px rgba(0,255,0,0.5);
}

.tune-btn {
    width: 36px;
    height: 36px;
    font-weight: bold;
    cursor: pointer;
    background: #383a40;
    color: #fff;
    border: 1px solid #2b2d31;
    border-radius: 4px;
    font-size: 18px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}
.tune-btn:hover { background: #4f525a; }

.countryBtn { 
    cursor: pointer;
    padding: 6px 16px;
    border: 1px solid #555;
    background: #383a40;
    color: #fff; 
    border-radius: 4px;
    font-weight: bold;
    transition: all 0.2s;
}
.countryBtn.active { 
    background: #00ff00; 
    color: #111; 
    border-color: #00cc00; 
}

.rds-box {
    display: inline-block;
    background: #111;
    color: #00ff00 !important;
    font-family: 'Courier New', Courier, monospace;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    letter-spacing: 2px;
    min-width: 95px;
    text-align: center;
    box-shadow: inset 0 0 5px rgba(0,255,0,0.4);
}

/* ================= POPUPS & TOOLTIPS ================= */
.leaflet-popup-content-wrapper {
    background: rgba(25, 25, 25, 0.85); 
    backdrop-filter: blur(4px); 
    color: #fff; 
    border: 1px solid #444;
    border-radius: 6px;
}
.leaflet-popup-content { margin: 14px; line-height: 1.5; }
hr { border: 0; border-top: 1px solid #555; margin: 10px 0; }

.leaflet-tooltip {
    background: rgba(25, 25, 25, 0.9);
    color: #fff; 
    border: 1px solid #444;
    border-radius: 4px;
    font-size: 13px;
    backdrop-filter: blur(4px);
}

.cov-btn {
    background: #333;
    color: #00ff00;
    border: 1px solid #00ff00;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 8px;
    width: 100%;
}
.cov-btn.active-cov { background: #ff4444; color: #fff; border-color: #ff4444; }
</style>
</head>

<body>

<div id="radioPanel">
    <div style="margin-bottom: 12px; font-size: 16px; text-align: center;"><b>ðŸ“» FM Tuner</b></div>
    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
        <button class="tune-btn" onclick="stepFreq(-0.1)">-</button>
        <div class="lcd-screen">
            <input id="freqInput" type="text" value="97.9">
            <div class="mhz-label">MHz</div>
        </div>
        <button class="tune-btn" onclick="stepFreq(0.1)">+</button>
    </div>
    <div style="display: flex; justify-content: center; gap: 8px;">
        <button id="btn-ro" class="countryBtn active" onclick="setCountry('ro')">Romania</button>
        <button id="btn-md" class="countryBtn" onclick="setCountry('md')">Moldova</button>
    </div>
</div>

<div id="map"></div>

<script>
var map = L.map('map').setView([46.1, 26.5], 7);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);
L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);

var txIcon = L.icon({ iconUrl: 'https://i.ibb.co/Bh7GDMv/antenna.png', iconSize: [26, 26], iconAnchor: [13, 26], popupAnchor: [0, -26] });
var warningIcon = L.icon({ iconUrl: 'https://i.ibb.co/C374c5g7/warning.png', iconSize: [26, 26], iconAnchor: [13, 26], popupAnchor: [0, -26] });
var receiverIcon = L.icon({ iconUrl: 'https://i.ibb.co/MkmK51LJ/yagi.png', iconSize: [34, 34], iconAnchor: [17, 34], popupAnchor: [0, -30] });

let geoLayer = null, allStations = [], currentCountry = "ro", receiverMarker = null, distanceLine = null, activeCoverages = {};

function formatDistance(km){ return km < 1 ? Math.round(km * 1000) + " m" : Math.round(km) + " km"; }

function loadStations(country){
    let file = country === "ro" ? "fm.json" : "fm_md.json";
    fetch(file).then(r => r.json()).then(data => { allStations = data.features; tune(); });
}
loadStations("ro");

/* ================= TUNE & PARSE ================= */
function tune(){
    if(!allStations.length) return;
    let freq = parseFloat(document.getElementById("freqInput").value);
    if(geoLayer) map.removeLayer(geoLayer);
    for (let key in activeCoverages) { map.removeLayer(activeCoverages[key]); }
    activeCoverages = {};

    let filtered = [];
    let regexFM = /\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b/;
    const errorKeywords = ["(**NO AUDIO**)", "(*BLANK CARRIER*)", "(**OFF**)", "(*NO AUDIO*)"];

    allStations.forEach(f => {
        let desc = f.properties.description || "";
        let stations = desc.split(/(?=\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b)/gi);

        let matched = stations.filter(s => {
            let m = s.match(regexFM);
            if(!m) return false;
            let fVal = parseFloat(m[0].replace(",", "."));
            return Math.abs(fVal - freq) <= 0.05;
        });

        if(matched.length > 0){
            let newF = JSON.parse(JSON.stringify(f));
            let hasMajorError = false;

            let formatted = matched.map(s => {
                let lineHasError = errorKeywords.some(keyword => s.includes(keyword));
                if(lineHasError) hasMajorError = true;

                let s2 = s.replace(regexFM, "<b style='color:#fff;'>$&</b>"); 
                
                // RDS REPAIR
                s2 = s2.replace(/(W|kW|w|kw)\s*((?:\[[^\]]+\]\s*)+)(\s*\([^)]+\))?$/, function(match, powerStr, rdsBlocks, extraText) {
                    extraText = extraText || "";
                    let rdsMatches = rdsBlocks.match(/\[([^\]]+)\]/g);
                    if(!rdsMatches) return match;
                    let frames = rdsMatches.map(frame => frame.slice(1, -1));
                    let safeFrames = encodeURIComponent(JSON.stringify(frames));
                    return powerStr + ` <span class="rds-box" data-frames="${safeFrames}" data-idx="0">[${frames[0]}]</span>` + extraText;
                });

                if(lineHasError) s2 = `<span class="status-error-text">${s2}</span>`;
                return s2;
            });

            newF.properties.description = formatted.join("<br><hr>");
            newF.properties._hasError = hasMajorError; 
            filtered.push(newF);
        }
    });

    geoLayer = L.geoJSON({ type: "FeatureCollection", features: filtered }, {
        pointToLayer: function(feature, latlng){ 
            return L.marker(latlng, {icon: feature.properties._hasError ? warningIcon : txIcon}); 
        },
        onEachFeature: function(feature, layer){
            let name = feature.properties.name || "Unknown Transmitter";
            let desc = feature.properties.description || "";
            let lat = feature.geometry.coordinates[1], lng = feature.geometry.coordinates[0];
            let id = lat + "_" + lng;

            // FIX TOOLTIP: Acum afiÈ™eazÄƒ corect textul Ã®n caseta gri
            layer.bindTooltip(`<b style="color:#fff;">${name}</b>`, { direction: 'top', offset: [0, -10], opacity: 1 });

            layer.on("mouseover", function(e){
                let tooltipContent = `<b style="color:#fff;">${name}</b>`;
                if (receiverMarker) {
                    let distKm = map.distance(receiverMarker.getLatLng(), e.latlng) / 1000;
                    tooltipContent += `<br><span style="font-size:11px; color:#ccc;">Dist: <span style="color:#fff;">${formatDistance(distKm)}</span></span>`;
                }
                layer.setTooltipContent(tooltipContent);
            });

            let pW = 100;
            let pM = desc.match(/-\s*([\d\.,]+)\s*(W|kW)/i);
            if (pM) {
                let v = parseFloat(pM[1].replace(",", "."));
                pW = pM[2].toLowerCase() === "kw" ? v * 1000 : v;
            }

            let cB = "cov_" + lat.toString().replace(/\./g, "") + "_" + lng.toString().replace(/\./g, "");
            let cH = `<button id="${cB}" class="cov-btn" onclick="toggleCoverage(${lat}, ${lng}, ${pW}, '${cB}')">ðŸ“¶ Show Coverage</button>`;

            layer.bindPopup(`<b style="font-size:15px; color:#fff;">${name}</b><br><hr>${desc}<hr>${cH}`);
        }
    }).addTo(map);
}

/* ================= RDS ANIMATION ================= */
setInterval(() => {
    document.querySelectorAll('.rds-box').forEach(box => {
        let framesAttr = box.getAttribute('data-frames');
        if (framesAttr) {
            let frames = JSON.parse(decodeURIComponent(framesAttr));
            if (frames.length > 1) {
                let idx = (parseInt(box.getAttribute('data-idx')) + 1) % frames.length;
                box.setAttribute('data-idx', idx);
                box.innerText = `[${frames[idx]}]`;
            }
        }
    });
}, 2500);

/* ================= CONTROLS ================= */
function stepFreq(d) {
    let i = document.getElementById("freqInput");
    let v = parseFloat(i.value) + d;
    if(v < 87.5) v = 108.0; if(v > 108.0) v = 87.5;
    i.value = v.toFixed(1); tune();
}

function setCountry(c){
    currentCountry = c;
    document.getElementById("btn-ro").classList.toggle("active", c === "ro");
    document.getElementById("btn-md").classList.toggle("active", c === "md");
    loadStations(c);
}
</script>
</body>
</html>
