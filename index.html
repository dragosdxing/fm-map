<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
@import url('https://fonts.cdnfonts.com/css/ds-digital');

html, body { margin:0; padding:0; background: #000; }
#map { height:100vh; width:100vw; }

/* ================= DARK MODE PANOU CONTROL ================= */
#radioPanel {
    position: absolute;
    top: 10px;
    left: 60px;
    background: #2b2d31; 
    color: #eee;
    padding: 16px 20px;
    border-radius: 8px;
    border: 1px solid #1e1f22;
    box-shadow: 0 4px 15px rgba(0,0,0,0.8);
    z-index: 1000;
    font-family: Arial, sans-serif;
    font-size: 14px;
    width: 280px;
}

/* ================= ECRAN LCD PENTRU FRECVEN»öƒÇ (VERDE) ================= */
.lcd-screen {
    background: #111;
    border: 1px solid #000;
    border-radius: 4px;
    padding: 4px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-width: 80px;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.9);
}

#freqInput { 
    background: transparent;
    border: none;
    color: #00ff00; /* VERDE */
    font-family: 'DS-Digital', sans-serif;
    font-size: 30px;
    font-weight: normal;
    text-align: center;
    width: 100%;
    outline: none;
    padding: 0;
    margin: 0;
    letter-spacing: 2px;
    text-shadow: 0 0 6px rgba(0,255,0,0.4);
}

#freqInput::-webkit-outer-spin-button,
#freqInput::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
#freqInput[type=number] { -moz-appearance: textfield; }

.mhz-label {
    color: #00ff00; /* VERDE */
    font-size: 11px;
    font-family: Arial, sans-serif;
    font-weight: bold;
    margin-top: -2px;
    letter-spacing: 1px;
    text-shadow: 0 0 3px rgba(0,255,0,0.5);
}

/* ================= BUTOANE TUNE ================= */
.tune-btn {
    width: 36px;
    height: 36px;
    font-weight: bold;
    cursor: pointer;
    background: #383a40;
    color: #fff;
    border: 1px solid #2b2d31;
    border-radius: 4px;
    font-size: 18px;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: 0.2s;
}
.tune-btn:hover { background: #4f525a; }

/* ================= BUTOANE »öƒÇRI ================= */
.countryBtn { 
    cursor: pointer;
    padding: 6px 16px;
    border: 1px solid #555;
    background: #383a40;
    color: #fff; 
    border-radius: 4px;
    font-weight: bold;
    transition: all 0.2s;
}
.countryBtn:hover { background: #404249; }
.countryBtn.active { 
    background: #00ff00; /* VERDE */
    color: #111; 
    border-color: #00cc00; 
}

/* ================= RAND BUTOANE ACTIUNI ================= */
.action-row {
    display: flex;
    gap: 8px;
    margin-top: 20px;
    width: 100%;
}

.action-btn {
    flex: 1;
    padding: 8px 4px;
    cursor: pointer;
    background: transparent;
    color: #fff; /* ALB */
    border: 1px solid #fff; /* ALB */
    border-radius: 4px;
    font-weight: bold;
    transition: 0.2s;
    font-size: 11px;
    text-align: center;
    text-decoration: none;
    display: flex;
    align-items: center;
    justify-content: center;
    white-space: nowrap;
}
.action-btn:hover { background: rgba(255,255,255,0.15); color: #fff; }

/* ================= STILIZARE RDS TIP RADIO ================= */
.rds-box {
    display: inline-block;
    background: #111;
    color: #00ff00; /* VERDE */
    font-family: 'Courier New', Courier, monospace;
    padding: 2px 6px;
    border-radius: 3px;
    font-weight: bold;
    letter-spacing: 2px;
    min-width: 95px;
    text-align: center;
    box-shadow: inset 0 0 5px rgba(0,255,0,0.4);
}

/* ================= DARK MODE LEAFLET POPUPS ================= */
.leaflet-popup-content-wrapper {
    background: rgba(25, 25, 25, 0.85); 
    backdrop-filter: blur(4px); 
    -webkit-backdrop-filter: blur(4px);
    color: #fff; /* ALB */
    border: 1px solid #444;
    box-shadow: 0 3px 14px rgba(0,0,0,0.8);
    border-radius: 6px;
}
.leaflet-popup-tip { background: rgba(25, 25, 25, 0.85); border-top: 1px solid #444; border-left: 1px solid #444; }
.leaflet-popup-content { margin: 14px; line-height: 1.5; }
.leaflet-container a.leaflet-popup-close-button { color: #fff; }
.leaflet-container a.leaflet-popup-close-button:hover { color: #aaa; }
hr { border: 0; border-top: 1px solid #555; margin: 10px 0; }
.leaflet-popup-content a { color: #fff; text-decoration: underline; }

/* ================= DARK MODE TOOLTIPS ================= */
.leaflet-tooltip {
    background: rgba(25, 25, 25, 0.9);
    color: #fff; /* ALB */
    border: 1px solid #444;
    box-shadow: 0 2px 8px rgba(0,0,0,0.8);
    border-radius: 4px;
    font-size: 13px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    text-align: center;
}
.leaflet-tooltip-top:before { border-top-color: #444; }

/* ================= COVERAGE BUTTON ================= */
.cov-btn {
    background: #333;
    color: #00ff00;
    border: 1px solid #00ff00;
    padding: 6px 10px;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 8px;
    width: 100%;
    transition: 0.2s;
    font-size: 13px;
}
.cov-btn:hover { background: #00ff00; color: #111; }
.cov-btn.active-cov { background: #ff4444; color: #fff; border-color: #ff4444; }
.cov-btn.active-cov:hover { background: #cc0000; }
</style>
</head>

<body>

<div id="radioPanel">
    <div style="margin-bottom: 12px; font-size: 16px; text-align: center;"><b>üìª FM Tuner</b></div>
    
    <div style="display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 20px;">
        <button class="tune-btn" onclick="stepFreq(-0.1)">-</button>
        <div class="lcd-screen">
            <input id="freqInput" type="text" value="97.9">
            <div class="mhz-label">MHz</div>
        </div>
        <button class="tune-btn" onclick="stepFreq(0.1)">+</button>
    </div>
    
    <div style="font-size: 12px; margin-bottom: 6px; text-align: center; color: #aaa;">Country / Database:</div>
    <div style="display: flex; justify-content: center; gap: 8px;">
        <button id="btn-ro" class="countryBtn active" onclick="setCountry('ro')">Romania</button>
        <button id="btn-md" class="countryBtn" onclick="setCountry('md')">Moldova</button>
    </div>

    <div class="action-row">
        <button id="geoBtn" class="action-btn" onclick="locateUser()">üìç Geolocation</button>
        <a href="https://servers.fmdx.org/" target="_blank" class="action-btn">üìª TEF Servers</a>
        <a href="https://www.youtube.com/@DragosDXing" target="_blank" class="action-btn">‚ñ∂Ô∏è My Youtube</a>
    </div>
</div>

<div id="map"></div>

<script>
/* ================= MAP ================= */
var map = L.map('map').setView([46.1, 26.5], 7);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);
L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{ maxZoom: 19 }).addTo(map);

/* ================= ICONS ================= */
var txIcon = L.icon({
    iconUrl: 'https://i.ibb.co/Bh7GDMv/antenna.png',
    iconSize: [26, 26], iconAnchor: [13, 26], popupAnchor: [0, -26], tooltipAnchor: [0, -26]
});
var receiverIcon = L.icon({
    iconUrl: 'https://i.ibb.co/MkmK51LJ/yagi.png',
    iconSize: [34, 34], iconAnchor: [17, 34], popupAnchor: [0, -30]
});

/* ================= GLOBALS ================= */
let geoLayer = null;
let allStations = [];
let currentCountry = "ro";
let receiverMarker = null;
let distanceLine = null;
let activeCoverages = {};

function formatDistance(km){
    if(km < 1) return Math.round(km * 1000) + " m";
    return Math.round(km) + " km";
}

async function getLocationName(lat, lon){
    try {
        let url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=12&addressdetails=1`;
        let r = await fetch(url, { headers: { "Accept": "application/json" } });
        let data = await r.json();
        return (data.address.city || data.address.town || data.address.village || data.address.municipality || data.address.county || "Unknown location");
    } catch { return "Unknown location"; }
}

/* ================= LOAD DATA ================= */
function loadStations(country){
    let file = country === "ro" ? "fm.json" : "fm_md.json";
    fetch(file).then(r => r.json()).then(data => {
        allStations = data.features;
        tune();
    }).catch(err => console.error("Eroare la √ÆncƒÉrcarea JSON:", err));
}
loadStations("ro"); 

/* ================= GEOLOCATION ================= */
function locateUser() {
    let btn = document.getElementById("geoBtn");

    if (!navigator.geolocation) {
        alert("Geoloca»õia nu este suportatƒÉ de browser-ul tƒÉu.");
        return;
    }

    btn.innerHTML = "‚è≥ Locating...";

    navigator.geolocation.getCurrentPosition(
        (position) => {
            let lat = position.coords.latitude;
            let lng = position.coords.longitude;
            let latlng = L.latLng(lat, lng);

            if (distanceLine) { map.removeLayer(distanceLine); distanceLine = null; }

            if (!receiverMarker) {
                receiverMarker = L.marker(latlng, { icon: receiverIcon, draggable: true }).addTo(map);
            } else {
                receiverMarker.setLatLng(latlng);
            }

            map.flyTo(latlng, 12);
            receiverMarker.bindPopup("<b>Searching location...</b>").openPopup();

            getLocationName(lat, lng).then(name => {
                receiverMarker.setPopupContent(`<b>üìç ${name}</b><br>(right click to remove)`);
            });

            btn.innerHTML = "üìç Geolocation";
            
            receiverMarker.off("drag");
            receiverMarker.off("dragend");
            receiverMarker.off("contextmenu");
            
            receiverMarker.on("drag", () => { if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; } });
            receiverMarker.on("dragend", () => {
                let p = receiverMarker.getLatLng();
                receiverMarker.setPopupContent("<b>Searching location...</b>");
                getLocationName(p.lat, p.lng).then(name => { receiverMarker.setPopupContent(`<b>üìç ${name}</b><br>(right click to remove)`); });
            });
            receiverMarker.on("contextmenu", () => {
                map.removeLayer(receiverMarker); receiverMarker = null;
                if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
            });

        }, 
        (error) => {
            alert("Nu am putut ob»õine loca»õia. AsigurƒÉ-te cƒÉ i-ai dat permisiunea de a folosi GPS-ul.");
            btn.innerHTML = "üìç Geolocation";
            console.error(error);
        },
        { enableHighAccuracy: true }
    );
}

/* ================= COVERAGE LOGIC ================= */
window.toggleCoverage = function(lat, lng, powerWatts, btnId) {
    let id = lat + "_" + lng;
    let btn = document.getElementById(btnId);

    if (activeCoverages[id]) {
        map.removeLayer(activeCoverages[id]);
        delete activeCoverages[id];
        if(btn) { btn.innerText = "üì∂ Show Coverage"; btn.classList.remove('active-cov'); }
        return;
    }

    let baseRadiusKm = Math.pow(powerWatts, 0.25);
    let rStrong = (baseRadiusKm * 5) * 1000;
    let rWeak = (baseRadiusKm * 9) * 1000;

    if (rStrong > 100000) rStrong = 100000; 
    if (rWeak > 180000) rWeak = 180000;

    let covWeak = L.circle([lat, lng], { radius: rWeak, color: 'none', fillColor: '#ffff00', fillOpacity: 0.15 });
    let covStrong = L.circle([lat, lng], { radius: rStrong, color: 'none', fillColor: '#00ff00', fillOpacity: 0.25 });

    let coverageGroup = L.layerGroup([covWeak, covStrong]).addTo(map);
    activeCoverages[id] = coverageGroup;

    if(btn) { btn.innerText = "‚ùå Hide Coverage"; btn.classList.add('active-cov'); }
};

/* ================= TUNE & PARSE ================= */
function tune(){
    if(!allStations.length) return;
    let freq = parseFloat(document.getElementById("freqInput").value);
    
    if(geoLayer) map.removeLayer(geoLayer);
    
    for (let key in activeCoverages) { map.removeLayer(activeCoverages[key]); }
    activeCoverages = {};

    let filtered = [];
    let regexFM = /\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b/;

    allStations.forEach(f => {
        let desc = f.properties.description || "";
        let stations = desc.split(/(?=\b(?:8[7-9]|9\d|10[0-8])[\.,]\d+\b)/gi);

        let matched = stations.filter(s => {
            let m = s.match(regexFM);
            if(!m) return false;
            let fVal = parseFloat(m[0].replace(",", "."));
            return Math.abs(fVal - freq) <= 0.05;
        });

        if(matched.length > 0){
            let newF = JSON.parse(JSON.stringify(f));
            let formatted = matched.map(s => {
                let s2 = s.replace(regexFM, "<b style='color:#fff;'>$&</b>"); 
                s2 = s2.replace(/(W|kW|w|kw)\s*((?:\[[^\]]+\]\s*)+)(\s*\([^)]+\))?$/, function(match, powerStr, rdsBlocks, extraText) {
                    extraText = extraText || "";
                    let frames = rdsBlocks.match(/\[([^\]]+)\]/g).map(frame => frame.slice(1, -1));
                    let safeFrames = encodeURIComponent(JSON.stringify(frames));
                    return powerStr + ` <span class="rds-box" data-frames="${safeFrames}" data-idx="0">[${frames[0]}]</span>` + extraText;
                });
                return s2;
            });
            newF.properties.description = formatted.join("<br><hr>");
            filtered.push(newF);
        }
    });

    geoLayer = L.geoJSON({
        type: "FeatureCollection", features: filtered
    }, {
        pointToLayer: function(feature, latlng){ return L.marker(latlng, {icon: txIcon}); },
        onEachFeature: function(feature, layer){
            let desc = feature.properties.description || "";
            let name = feature.properties.name || "Unknown Transmitter";
            
            let lat = feature.geometry.coordinates[1];
            let lng = feature.geometry.coordinates[0];
            let id = lat + "_" + lng;

            let powerWatts = 100;
            let powerMatch = desc.match(/-\s*([\d\.,]+)\s*(W|kW)/i);
            if (powerMatch) {
                let val = parseFloat(powerMatch[1].replace(",", "."));
                let unit = powerMatch[2].toLowerCase();
                powerWatts = unit === "kw" ? val * 1000 : val;
            }

            let covBtnId = "cov_" + lat.toString().replace(/\./g, "") + "_" + lng.toString().replace(/\./g, "");
            
            let coverageHtml = `<button id="${covBtnId}" class="cov-btn" onclick="toggleCoverage(${lat}, ${lng}, ${powerWatts}, '${covBtnId}')">üì∂ Show Coverage</button>`;

            // TOOLTIP ALB CU DISTANTA SI AZIMUT
            layer.bindTooltip(`<b style="color:#fff;">${name}</b>`, { direction: 'top', offset: [0, -10], opacity: 1 });

            layer.on("mouseover", function(e){
                let tooltipContent = `<b style="color:#fff;">${name}</b>`;
                if (receiverMarker) {
                    let p1 = receiverMarker.getLatLng();
                    let p2 = e.latlng;
                    let distKm = map.distance(p1, p2) / 1000;
                    let azimuth = bearing(p1, p2);
                    tooltipContent += `<br><span style="font-size:11px; color:#ccc;">Dist: <span style="color:#fff;">${formatDistance(distKm)}</span><br>Beam: <span style="color:#fff;">${azimuth.toFixed(0)}¬∞</span></span>`;
                }
                layer.setTooltipContent(tooltipContent);
            });

            // POPUP PRINCIPAL FARA DISTANTA/AZIMUT
            layer.bindPopup(`<b style="font-size:15px; color:#fff;">${name}</b><br><hr>${desc}<hr>${coverageHtml}`);

            layer.on('popupopen', function() {
                let btn = document.getElementById(covBtnId);
                if (btn) {
                    if (activeCoverages[id]) {
                        btn.innerText = "‚ùå Hide Coverage";
                        btn.classList.add('active-cov');
                    } else {
                        btn.innerText = "üì∂ Show Coverage";
                        btn.classList.remove('active-cov');
                    }
                }
            });

            layer.on("contextmenu", function(e){
                if(!receiverMarker) return;
                if(distanceLine) map.removeLayer(distanceLine);

                let p1 = receiverMarker.getLatLng();
                let p2 = e.latlng;
                
                // LINIE DISTANTA RO»òIE DASHED
                distanceLine = L.polyline([p1, p2], {color: "red", weight: 3, dashArray: "5, 5"}).addTo(map);

                // Reafisam POPUP-ul principal curat
                layer.bindPopup(
                    `<b style="font-size:15px; color:#fff;">${name}</b><br><hr>${desc}<hr>${coverageHtml}`,
                    { autoPan: false } 
                ).openPopup();

                map.flyToBounds(distanceLine.getBounds(), { paddingTopLeft: [50, 220], paddingBottomRight: [50, 50], maxZoom: 14 });
            });
        }
    }).addTo(map);
}

/* ================= RDS ANIMATION SCRIPT ================= */
setInterval(() => {
    document.querySelectorAll('.rds-box').forEach(box => {
        let framesAttr = box.getAttribute('data-frames');
        if (framesAttr) {
            let frames = JSON.parse(decodeURIComponent(framesAttr));
            if (frames.length > 1) {
                let idx = parseInt(box.getAttribute('data-idx'));
                idx = (idx + 1) % frames.length; 
                box.setAttribute('data-idx', idx);
                box.innerText = `[${frames[idx]}]`;
            }
        }
    });
}, 2500);

/* ================= AUTO TUNE CONTROLS ================= */
function parseFrequency() {
    let input = document.getElementById("freqInput");
    let raw = input.value.trim().replace(',', '.');
    let val = parseFloat(raw);
    
    if (!isNaN(val)) {
        if (val >= 875 && val <= 1080 && raw.indexOf('.') === -1) {
            val = val / 10;
        }
        if (val < 87.5) val = 87.5;
        if (val > 108.0) val = 108.0;
    } else {
        val = 97.9;
    }
    
    input.value = val.toFixed(1);
    tune();
}

function stepFreq(delta) {
    let input = document.getElementById("freqInput");
    let val = parseFloat(input.value) + delta;
    if(val < 87.5) val = 108.0;
    if(val > 108.0) val = 87.5;
    input.value = val.toFixed(1);
    tune();
}

let inputField = document.getElementById("freqInput");
inputField.addEventListener("blur", parseFrequency);
inputField.addEventListener("keyup", e => { 
    if(e.key === "Enter") {
        inputField.blur();
    } 
});

/* ================= COUNTRY SWITCH ================= */
function setCountry(c){
    currentCountry = c;
    document.getElementById("btn-ro").classList.toggle("active", c === "ro");
    document.getElementById("btn-md").classList.toggle("active", c === "md");
    loadStations(c);
}

/* ================= RECEIVER & BEARING ================= */
map.on("contextmenu", function(e){
    if(e.originalEvent.target.closest(".leaflet-marker-icon")) return;
    if(receiverMarker){ map.removeLayer(receiverMarker); receiverMarker = null; }
    if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }

    receiverMarker = L.marker(e.latlng, { icon: receiverIcon, draggable: true }).addTo(map);
    receiverMarker.bindPopup("<b>Searching location...</b>").openPopup();

    getLocationName(e.latlng.lat, e.latlng.lng).then(name => { receiverMarker.setPopupContent(`<b>üìç ${name}</b><br>(right click to remove)`); });
    
    receiverMarker.on("drag", () => { if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; } });
    receiverMarker.on("dragend", () => {
        let p = receiverMarker.getLatLng();
        receiverMarker.setPopupContent("<b>Searching location...</b>");
        getLocationName(p.lat, p.lng).then(name => { receiverMarker.setPopupContent(`<b>üìç ${name}</b><br>(right click to remove)`); });
    });
    receiverMarker.on("contextmenu", () => {
        map.removeLayer(receiverMarker); receiverMarker = null;
        if(distanceLine){ map.removeLayer(distanceLine); distanceLine = null; }
    });
});

function bearing(a, b){
    let lat1 = a.lat * Math.PI / 180; let lat2 = b.lat * Math.PI / 180;
    let dLon = (b.lng - a.lng) * Math.PI / 180;
    let y = Math.sin(dLon) * Math.cos(lat2);
    let x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;
    return (brng + 360) % 360;
}
</script>
</body>
</html>
