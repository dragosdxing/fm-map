<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;}
#map{height:100vh;width:100vw;}

#radioPanel{
    position:absolute;
    top:10px;
    left:60px;
    background:white;
    padding:10px;
    border-radius:10px;
    box-shadow:0 3px 12px rgba(0,0,0,0.35);
    z-index:1000;
    font-family:Arial;
}

#freqInput{
    width:70px;
    text-align:center;
    font-size:16px;
}

button{
    margin:2px;
    padding:4px 8px;
    cursor:pointer;
}
</style>
</head>

<body>

<div id="radioPanel">
<b>FM Tuner</b><br>

Frequency:<br>
<button onclick="stepDown()">âˆ’</button>
<input id="freqInput" type="text" value="97.9">
<button onclick="stepUp()">+</button>

<br><br>
Country:<br>
<button onclick="setCountry('ro')">Romania</button>
<button onclick="setCountry('md')">Moldova</button>
</div>

<div id="map"></div>

<script>

var map = L.map('map').setView([47.2, 26.5], 7);

L.tileLayer(
'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
{ maxZoom:19 }
).addTo(map);

L.tileLayer(
'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',
{ maxZoom:19, opacity:0.8 }
).addTo(map);

var antennaIcon = L.icon({
    iconUrl: 'https://i.ibb.co/TtThCNR/antenna.png',
    iconSize: [28,28],
    iconAnchor: [14,28],
    popupAnchor: [0,-28]
});

let allStationsRO = [];
let allStationsMD = [];
let currentCountry = "ro";
let geoLayer;

fetch('fm_ro.json')
.then(r=>r.json())
.then(data=>{
    allStationsRO = data.features;
    tune();
});

fetch('fm_md.json')
.then(r=>r.json())
.then(data=>{
    allStationsMD = data.features;
});

function setCountry(c){
    currentCountry = c;
    tune();
}

function stepUp(){
    let f = parseFloat(freqInput.value);
    f = Math.min(108,(f+0.1));
    freqInput.value = f.toFixed(1);
    tune();
}

function stepDown(){
    let f = parseFloat(freqInput.value);
    f = Math.max(87.5,(f-0.1));
    freqInput.value = f.toFixed(1);
    tune();
}

document.getElementById("freqInput").addEventListener("keydown",function(e){
    if(e.key==="Enter") tune();
});

function tune(){

    let freq = parseFloat(document.getElementById("freqInput").value);

    if(geoLayer) map.removeLayer(geoLayer);

    let dataset = (currentCountry==="ro") ? allStationsRO : allStationsMD;

    let filteredFeatures = [];

    dataset.forEach(f => {

        let desc = f.properties.description || "";

        let stations = desc.split(/(?=\d{2,3}\.\d\s[hv])/i);

        let matched = stations.filter(s => {

            let m = s.match(/\d{2,3}\.\d/);
            if(!m) return false;

            return Math.abs(parseFloat(m[0]) - freq) < 0.05;
        });

        if(matched.length>0){

            let newFeature = JSON.parse(JSON.stringify(f));
            newFeature.properties.description = matched.join("<br>");

            filteredFeatures.push(newFeature);
        }
    });

    geoLayer = L.geoJSON({
        type:"FeatureCollection",
        features: filteredFeatures
    },{
        pointToLayer: function(feature, latlng){
            return L.marker(latlng,{icon:antennaIcon});
        },
        onEachFeature: function(feature, layer){
            layer.bindPopup(
                "<b>" + (feature.properties.name || "") + "</b><br>" +
                feature.properties.description
            );
        }
    }).addTo(map);
}

</script>
</body>
</html>
