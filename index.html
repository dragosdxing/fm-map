<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>FM Map Romania & Moldova</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
html,body{margin:0;padding:0;}
#map{height:100vh;width:100vw;}

#radioPanel{
    position:absolute;
    top:10px;
    left:60px;
    background:white;
    padding:10px;
    border-radius:10px;
    box-shadow:0 3px 10px rgba(0,0,0,0.35);
    z-index:1000;
    font-family:Arial;
    font-size:14px;
}

#radioPanel input{
    width:70px;
}

#radioPanel button{
    margin-top:4px;
    margin-right:4px;
}
</style>
</head>

<body>

<div id="radioPanel">
    <b>FM Tuner</b><br>
    <label>Frequency:</label>
    <input id="freqInput" type="number" step="0.1" min="87.5" max="108" value="97.9">
    <button onclick="tune()">Tune</button>
    <br><br>
    <b>Country:</b><br>
    <button onclick="switchCountry('RO')">Romania</button>
    <button onclick="switchCountry('MD')">Moldova</button>
</div>

<div id="map"></div>

<script>

// ================= MAP =================

var map = L.map('map').setView([45.8, 26.5],7);

// --- ESRI SATELLITE ---
var esriSat = L.tileLayer(
'https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19,
    attribution:'Tiles © Esri'
}).addTo(map);

// --- ESRI LABELS ---
var esriLabels = L.tileLayer(
'https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19,
    attribution:'Labels © Esri'
}).addTo(map);


// ================= VARIABLES =================

let allStationsRO = [];
let allStationsMD = [];

let geoLayerRO;
let geoLayerMD;

let filteredLayer;

let currentCountry = "RO";


// ================= DESCRIPTION FORMAT =================

function formatDescription(desc){

    // pune fiecare frecvență pe linie nouă
    desc = desc.replace(/(\d{2,3}\.\d\s[hv])/gi,"<br>$1");

    // elimină primul <br>
    if(desc.startsWith("<br>")) desc = desc.substring(4);

    return desc;
}


// ================= LOAD ROMANIA =================

fetch('fm_ro.json')
.then(r => r.json())
.then(data => {

    allStationsRO = data.features;

    geoLayerRO = L.geoJSON(data,{
        onEachFeature: function(feature, layer){

            let desc = formatDescription(feature.properties.description || "");

            layer.bindPopup(
                "<b>" + (feature.properties.name || "") + "</b><br>" + desc
            );
        }
    }).addTo(map);
});


// ================= LOAD MOLDOVA =================

fetch('fm_md.json')
.then(r => r.json())
.then(data => {

    allStationsMD = data.features;

    geoLayerMD = L.geoJSON(data,{
        onEachFeature: function(feature, layer){

            let desc = formatDescription(feature.properties.description || "");

            layer.bindPopup(
                "<b>" + (feature.properties.name || "") + "</b><br>" + desc
            );
        }
    });
});


// ================= SWITCH COUNTRY =================

function switchCountry(c){

    currentCountry = c;

    if(geoLayerRO) map.removeLayer(geoLayerRO);
    if(geoLayerMD) map.removeLayer(geoLayerMD);
    if(filteredLayer) map.removeLayer(filteredLayer);

    if(c === "RO"){
        geoLayerRO.addTo(map);
        map.setView([45.8,26.5],7);
    }else{
        geoLayerMD.addTo(map);
        map.setView([47.0,28.6],8);
    }

    tune();
}


// ================= TUNER =================

function tune(){

    let freq = parseFloat(document.getElementById("freqInput").value);

    if(filteredLayer) map.removeLayer(filteredLayer);

    let dataset = (currentCountry === "RO") ? allStationsRO : allStationsMD;

    let filteredFeatures = [];

    dataset.forEach(f => {

        let desc = f.properties.description || "";

        // separă fiecare post
        let stations = desc.split(/(?=\d{2,3}\.\d\s[hv])/i);

        let matched = stations.filter(s => {

            let m = s.match(/\d{2,3}\.\d/);
            if(!m) return false;

            return Math.abs(parseFloat(m[0]) - freq) < 0.05;
        });

        if(matched.length > 0){

            let newFeature = JSON.parse(JSON.stringify(f));
            newFeature.properties.description = formatDescription(matched.join("<br>"));

            filteredFeatures.push(newFeature);
        }
    });

    filteredLayer = L.geoJSON({
        type:"FeatureCollection",
        features: filteredFeatures
    },{
        onEachFeature: function(feature, layer){

            layer.bindPopup(
                "<b>" + (feature.properties.name || "") + "</b><br>" +
                feature.properties.description
            );
        }
    }).addTo(map);
}

</script>
</body>
</html>
