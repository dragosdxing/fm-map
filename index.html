<script>

/* ================= MAP ================= */

var map = L.map('map').setView([46.1, 26.5], 7);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19
}).addTo(map);

L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}',{
    maxZoom:19
}).addTo(map);

/* ================= ICONS ================= */

var txIcon = L.icon({
    iconUrl:'https://i.ibb.co/Bh7GDMv/antenna.png',
    iconSize:[26,26],
    iconAnchor:[13,26],
    popupAnchor:[0,-26]
});

var receiverIcon = L.icon({
    iconUrl:'https://i.ibb.co/MkmK51LJ/yagi.png',
    iconSize:[34,34],
    iconAnchor:[17,34],
    popupAnchor:[0,-30]
});

/* ================= GLOBALS ================= */

let allStations=[];
let markersLayer=L.layerGroup().addTo(map);
let currentCountry="ro";
let receiverMarker=null;
let distanceLine=null;

/* ================= UTIL ================= */

function normalizeFreq(f){
    f=parseFloat(f);
    if(isNaN(f)) f=87.5;
    if(f<87.5) f=87.5;
    if(f>108) f=108;
    return parseFloat(f.toFixed(1));
}

function formatDistance(km){
    if(km<1) return Math.round(km*1000)+" m";
    return Math.round(km)+" km";
}

function haversine(a,b){
    let R=6371;
    let dLat=(b.lat-a.lat)*Math.PI/180;
    let dLon=(b.lng-a.lng)*Math.PI/180;
    let lat1=a.lat*Math.PI/180;
    let lat2=b.lat*Math.PI/180;

    let x=Math.sin(dLat/2)**2+
          Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);

    return 2*R*Math.asin(Math.sqrt(x));
}

function bearing(a,b){
    let lat1=a.lat*Math.PI/180;
    let lat2=b.lat*Math.PI/180;
    let dLon=(b.lng-a.lng)*Math.PI/180;

    let y=Math.sin(dLon)*Math.cos(lat2);
    let x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);

    return (Math.atan2(y,x)*180/Math.PI+360)%360;
}

/* ================= RDS SCROLL ================= */

function rdsScroll(text){
    let padded="   "+text+"   ";
    let i=0;
    return setInterval(()=>{
        let s=padded.substring(i,i+8);
        if(s.length<8) s+=padded.substring(0,8-s.length);
        document.title="ðŸ“» "+s;
        i=(i+1)%padded.length;
    },200);
}

let rdsTimer=null;

/* ================= TUNE ================= */

function tune(){

    markersLayer.clearLayers();

    let freq=normalizeFreq(document.getElementById("freqInput").value);
    document.getElementById("freqInput").value=freq;

    let usedCoords={};

    let foundStations=allStations.filter(f=>{
        return normalizeFreq(f.properties.freq)===freq;
    });

    if(foundStations.length===0){
        if(rdsTimer) clearInterval(rdsTimer);
        document.title="FM MAP";
    }

    foundStations.forEach(f=>{

        let lat=f.geometry.coordinates[1];
        let lon=f.geometry.coordinates[0];

        let key=lat.toFixed(4)+","+lon.toFixed(4);

        if(usedCoords[key]){
            lat+= (Math.random()-0.5)*0.05;
            lon+= (Math.random()-0.5)*0.05;
        }

        usedCoords[key]=true;

        let marker=L.marker([lat,lon],{icon:txIcon}).addTo(markersLayer);

        marker.bindPopup(
            "<b>"+f.properties.name+"</b><br>"+
            f.properties.freq+" MHz<br>"+
            f.properties.site
        );

        marker.on("click",()=>{
            if(rdsTimer) clearInterval(rdsTimer);
            rdsTimer=rdsScroll(f.properties.name);
        });

        marker.on("contextmenu",()=>{

            if(!receiverMarker){
                alert("Place receiver first (right click on map)");
                return;
            }

            let tx={lat:lat,lng:lon};
            let rx=receiverMarker.getLatLng();

            let dist=haversine(tx,rx);
            let az=bearing(tx,rx);

            if(distanceLine){
                map.removeLayer(distanceLine);
            }

            distanceLine=L.polyline([tx,rx],{color:"yellow"}).addTo(map);

            marker.bindPopup(
                "<b>"+f.properties.name+"</b><br>"+
                f.properties.freq+" MHz<br>"+
                "Distance: "+formatDistance(dist)+"<br>"+
                "Azimuth: "+Math.round(az)+"Â°"
            ).openPopup();
        });

    });
}

/* ================= AUTO TUNE ================= */

document.getElementById("freqInput").addEventListener("input",tune);
document.getElementById("freqInput").addEventListener("keyup",e=>{
    if(e.key==="Enter") tune();
});

function stepFreq(step){
    let v=parseFloat(document.getElementById("freqInput").value);
    v=normalizeFreq(v+step);
    document.getElementById("freqInput").value=v;
    tune();
}

/* ================= COUNTRY ================= */

function loadStations(country){
    let file = country==="ro" ? "fm.json" : "fm_md.json";
    fetch(file)
        .then(r=>r.json())
        .then(data=>{
            allStations=data.features;
            tune();
        });
}

function setCountry(c){
    currentCountry=c;
    loadStations(c);
}

loadStations("ro");

/* ================= RECEIVER ================= */

map.on("contextmenu",function(e){

    if(e.originalEvent.target.closest(".leaflet-marker-icon")) return;

    if(receiverMarker){
        map.removeLayer(receiverMarker);
        receiverMarker=null;
    }

    if(distanceLine){
        map.removeLayer(distanceLine);
        distanceLine=null;
    }

    receiverMarker=L.marker(e.latlng,{
        icon:receiverIcon,
        draggable:true
    }).addTo(map);

    receiverMarker.bindPopup("<b>Searching...</b>").openPopup();

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`)
        .then(r=>r.json())
        .then(d=>{
            let a=d.address;
            let name=a.city||a.town||a.village||a.county||"Unknown";
            receiverMarker.setPopupContent("<b>"+name+"</b><br>(right click to remove)");
        });

    receiverMarker.on("drag",()=>{
        if(distanceLine){
            map.removeLayer(distanceLine);
            distanceLine=null;
        }
    });

    receiverMarker.on("contextmenu",()=>{
        map.removeLayer(receiverMarker);
        receiverMarker=null;

        if(distanceLine){
            map.removeLayer(distanceLine);
            distanceLine=null;
        }
    });

});

</script>
